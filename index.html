<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raza Jumma Masjid - Ravetha Nagar</title>
    <meta name="theme-color" content="#064e3b">
    
    <!-- Core Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- Notifications -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Firebase SDKs (Included for future-proofing, but Telegram is Main Sync) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>

    <style>
        body {
            font-family: 'Noto Sans', sans-serif;
            background-color: #f8fafc;
            background-image: radial-gradient(#166534 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }
        h1, h2, h3, .arabic-text, .surah-name { font-family: 'Amiri', serif; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
        }
        
        .prayer-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            background-color: white; /* Default background */
        }
        
        /* Strong Highlight for Running Prayer */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); }
            100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
        }

        /* Important: Override background for active card */
        .prayer-card.running-now {
            background: linear-gradient(135deg, #ecfdf5 0%, #ffffff 100%) !important;
            border: 2px solid #16a34a !important;
            transform: scale(1.05);
            z-index: 10;
            animation: pulse-green 2s infinite;
        }
        
        .prayer-card.running-now::after {
            content: 'Running Now';
            position: absolute;
            top: 0;
            right: 0;
            background: #16a34a;
            color: white;
            font-size: 9px;
            font-weight: bold;
            padding: 3px 8px;
            border-bottom-left-radius: 8px;
            box-shadow: -2px 2px 4px rgba(0,0,0,0.1);
        }

        .surah-item:hover { background-color: #f0fdf4; border-color: #16a34a; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col pb-safe">

    <!-- Zakat Modal -->
    <div id="zakatModal" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl relative overflow-hidden">
            <button onclick="document.getElementById('zakatModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-3 text-amber-600"><i class="fas fa-calculator fa-2x"></i></div>
                <h3 class="text-2xl font-bold text-slate-800">Zakat Calculator</h3>
                <p class="text-xs text-slate-500">Calculate 2.5% of your eligible wealth</p>
            </div>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <div><label class="text-xs font-bold text-slate-500 uppercase">Cash & Bank Balance</label><div class="flex items-center border rounded-lg px-3 bg-slate-50 focus-within:ring-2 ring-green-500"><span class="text-slate-400">â‚¹</span><input type="number" id="z_cash" class="w-full p-3 bg-transparent outline-none" placeholder="0"></div></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Gold & Silver Value</label><div class="flex items-center border rounded-lg px-3 bg-slate-50 focus-within:ring-2 ring-green-500"><span class="text-slate-400">â‚¹</span><input type="number" id="z_gold" class="w-full p-3 bg-transparent outline-none" placeholder="0"></div></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase">Investments & Shares</label><div class="flex items-center border rounded-lg px-3 bg-slate-50 focus-within:ring-2 ring-green-500"><span class="text-slate-400">â‚¹</span><input type="number" id="z_invest" class="w-full p-3 bg-transparent outline-none" placeholder="0"></div></div>
                <div><label class="text-xs font-bold text-red-400 uppercase">Liabilities (Debts)</label><div class="flex items-center border border-red-100 rounded-lg px-3 bg-red-50 focus-within:ring-2 ring-red-500"><span class="text-red-400">â‚¹</span><input type="number" id="z_debt" class="w-full p-3 bg-transparent outline-none" placeholder="0"></div></div>
            </div>
            <div class="mt-6 p-4 bg-green-50 rounded-xl border border-green-100 text-center">
                <p class="text-sm text-green-800 mb-1">Total Zakat Payable</p>
                <div class="text-3xl font-bold text-green-700" id="zakatResult">â‚¹ 0</div>
            </div>
            <button onclick="calculateZakat()" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition">Calculate</button>
        </div>
    </div>

    <!-- Quran Modal -->
    <div id="quranModal" class="fixed inset-0 bg-slate-900/95 z-[80] hidden flex flex-col backdrop-blur-md transition-all">
        <div class="bg-white p-4 shadow-md flex justify-between items-center z-10">
            <h3 class="text-lg font-bold text-green-800 flex items-center gap-2"><i class="fas fa-book-open"></i> Al-Quran</h3>
            <button onclick="document.getElementById('quranModal').classList.add('hidden')" class="text-slate-500 hover:text-red-500 w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4 bg-slate-50 border-b">
            <input type="text" id="surahSearch" placeholder="Search Surah (e.g. Yasin)..." class="w-full p-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-green-500" oninput="filterSurahs()">
        </div>
        <div id="surahList" class="flex-grow overflow-y-auto p-4 space-y-2 pb-20"></div>
        
        <!-- Reader -->
        <div id="readerView" class="hidden absolute inset-0 bg-white z-20 flex flex-col">
            <div class="bg-green-800 text-white p-4 shadow-md flex justify-between items-center">
                <button onclick="document.getElementById('readerView').classList.add('hidden')" class="text-white/80 hover:text-white"><i class="fas fa-arrow-left"></i> Back</button>
                <h3 id="readerTitle" class="font-bold font-serif text-lg">Surah</h3>
                <div class="w-6"></div>
            </div>
            <div id="readerContent" class="flex-grow overflow-y-auto p-6 space-y-6 pb-20 bg-[#fffdf5]"></div>
        </div>
    </div>

    <!-- Countdown Modal -->
    <div id="countdownModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeCountdown()">
        <div class="bg-white rounded-2xl p-8 w-full max-w-sm text-center shadow-2xl transform scale-95 transition-all" onclick="event.stopPropagation()">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600"><i class="fas fa-clock fa-2x"></i></div>
            <h3 class="text-2xl font-bold text-slate-800 mb-2" id="modalPrayerName">Fajr</h3>
            <p class="text-gray-500 mb-6 text-sm">Time Remaining until Start</p>
            <div class="text-4xl font-mono font-bold text-amber-600 mb-8" id="modalTimer">00:00:00</div>
            <button onclick="closeCountdown()" class="w-full bg-slate-100 text-slate-700 py-3 rounded-xl font-semibold hover:bg-slate-200">Close</button>
        </div>
    </div>

    <!-- Header -->
    <header class="relative bg-[#064e3b] text-white pb-24 pt-12 overflow-hidden rounded-b-[2.5rem] shadow-2xl">
        <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/arabesque.png');"></div>
        <div class="container mx-auto px-4 text-center relative z-10">
            <h1 class="text-4xl md:text-5xl font-bold mb-2 tracking-tight">Raza Jumma Masjid</h1>
            <p class="text-xl md:text-2xl text-green-200/80 font-light arabic-text mb-6">Ø±Ø¶Ø§ Ø¬Ù…Ø¹Ø© Ù…Ø³Ø¬Ø¯</p>
            <div class="inline-flex items-center gap-2 bg-white/10 backdrop-blur-md border border-white/20 px-5 py-2.5 rounded-full text-sm font-medium shadow-lg">
                <i class="far fa-calendar-alt text-amber-400"></i>
                <span id="hijriDate">Loading...</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 -mt-16 relative z-20 space-y-8 pb-12">

        <!-- Ayat of the Day -->
        <section class="max-w-4xl mx-auto transform hover:scale-[1.01] transition duration-500">
            <div class="glass-panel rounded-3xl p-8 text-center relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent opacity-50"></div>
                <div class="mb-4 inline-block">
                    <span class="text-[10px] font-bold text-green-600 uppercase tracking-[0.2em] border border-green-200 px-3 py-1 rounded-full bg-green-50">Ayat of the Day</span>
                </div>
                <p class="arabic-text text-3xl md:text-4xl font-bold text-slate-800 mb-4 leading-loose dir-rtl drop-shadow-sm">
                    Ø¥ÙÙ†ÙÙ‘ Ø§Ù„ØµÙÙ‘Ù„ÙØ§Ø©Ù ÙƒÙØ§Ù†ÙØªÙ’ Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ù’Ù…ÙØ¤Ù’Ù…ÙÙ†ÙÙŠÙ†Ù ÙƒÙØªÙØ§Ø¨Ù‹Ø§ Ù…ÙÙˆÙ’Ù‚ÙÙˆØªÙ‹Ø§
                </p>
                <p class="text-slate-600 font-medium italic text-base md:text-lg">
                    "Beshak Namaz momino par muqarrar waqt mein farz ki gayi hai."
                </p>
                <div class="text-xs text-slate-400 mt-3 font-semibold tracking-wide">(Surah An-Nisa: 103)</div>
            </div>
        </section>

        <!-- Tools Grid (Quran & Zakat) -->
        <section class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Quran Card -->
            <div onclick="openQuran()" class="glass-panel rounded-2xl p-4 flex items-center justify-between cursor-pointer hover:bg-white transition group border-l-4 border-green-600">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-700 group-hover:scale-110 transition"><i class="fas fa-book-open fa-lg"></i></div>
                    <div><h3 class="font-bold text-slate-800 text-lg">Al-Quran</h3><p class="text-xs text-slate-500">Read 114 Surahs</p></div>
                </div>
                <i class="fas fa-chevron-right text-slate-300"></i>
            </div>
            <!-- Zakat Card -->
            <div onclick="document.getElementById('zakatModal').classList.remove('hidden')" class="glass-panel rounded-2xl p-4 flex items-center justify-between cursor-pointer hover:bg-white transition group border-l-4 border-amber-500">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 group-hover:scale-110 transition"><i class="fas fa-calculator fa-lg"></i></div>
                    <div><h3 class="font-bold text-slate-800 text-lg">Zakat Calculator</h3><p class="text-xs text-slate-500">Calculate 2.5%</p></div>
                </div>
                <i class="fas fa-chevron-right text-slate-300"></i>
            </div>
        </section>

        <!-- Prayer Times Grid -->
        <section class="max-w-5xl mx-auto">
            <div class="glass-panel rounded-3xl p-6 md:p-8 bg-white/95">
                <div class="flex justify-between items-end mb-6 border-b border-slate-100 pb-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-mosque text-green-700"></i> Prayer Times</h2>
                        <p class="text-xs text-slate-400 mt-1 pl-7">Bangalore â€¢ Hanafi</p>
                    </div>
                    <!-- Next Prayer Indicator -->
                    <div class="text-right">
                        <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Next Prayer</div>
                        <div id="nextPrayerName" class="text-sm font-bold text-green-700">Loading...</div>
                    </div>
                </div>

                <!-- Grid -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-8" id="prayerGrid"></div>

                <!-- Special Times Row -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="bg-slate-50 p-5 rounded-2xl border border-slate-200 flex justify-between items-center relative overflow-hidden">
                        <div class="text-center w-1/2 border-r border-slate-200 pr-4">
                            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Sehri Ends</div>
                            <div class="text-xl font-bold text-slate-700" id="sehriTime">--:--</div>
                        </div>
                        <div class="text-center w-1/2 pl-4">
                            <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Iftar Start</div>
                            <div class="text-xl font-bold text-slate-700" id="iftarTime">--:--</div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-gradient-to-r from-amber-50 to-orange-50 p-5 rounded-2xl border border-amber-100 flex items-center justify-between relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="text-amber-800 font-bold text-lg flex items-center gap-2 mb-1"><i class="fas fa-star-and-crescent"></i> Jumu'ah</div>
                            <div class="text-xs text-amber-700/70">Khutbah 30 mins prior</div>
                        </div>
                        <div class="text-right relative z-10">
                            <div class="text-[10px] text-amber-600 uppercase font-bold tracking-wider">Jamaat</div>
                            <div class="text-3xl font-bold text-amber-600" id="jummaTimeDisplay">--:--</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Islamic Festivals -->
        <section class="max-w-4xl mx-auto">
            <h3 class="text-lg font-bold text-slate-700 mb-4 px-2 flex items-center gap-2">
                <i class="fas fa-star text-amber-500"></i> Upcoming Islamic Events
            </h3>
            
            <div id="featuredFestival" class="bg-gradient-to-br from-[#064e3b] to-[#047857] rounded-3xl p-6 md:p-8 text-white shadow-xl relative overflow-hidden mb-6">
                <div class="shimmer w-full h-40 rounded-xl opacity-20"></div>
            </div>

            <button onclick="toggleFestivals()" id="toggleFestBtn" class="w-full py-3 bg-white border border-slate-200 rounded-xl text-slate-600 font-bold text-sm shadow-sm hover:bg-slate-50 transition flex items-center justify-center gap-2">
                <span>See More Festivals</span>
                <i class="fas fa-chevron-down transition-transform duration-300" id="toggleIcon"></i>
            </button>

            <div id="allFestivals" class="hidden grid-cols-1 md:grid-cols-2 gap-4 mt-4 transition-all duration-300">
                <!-- Injected via JS -->
            </div>
        </section>

        <!-- Donation Section -->
        <section class="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto">
            <div class="glass-panel rounded-3xl overflow-hidden h-full flex flex-col">
                <div class="flex text-center bg-slate-50 border-b border-slate-200">
                    <button onclick="switchTab('money')" id="tab-money" class="flex-1 py-4 font-bold text-green-700 border-b-2 border-green-600 bg-white text-sm uppercase transition-all">Chanda for Masjid</button>
                    <button onclick="switchTab('material')" id="tab-material" class="flex-1 py-4 font-bold text-slate-400 text-sm uppercase hover:text-green-600 transition-all">Donate Materials</button>
                </div>
                
                <!-- Money Content -->
                <div id="content-money" class="p-8 text-center flex-grow flex flex-col justify-center items-center fade-in">
                    <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-4"><i class="fas fa-hand-holding-dollar fa-lg"></i></div>
                    <h3 class="text-lg font-bold text-slate-800">Mumtaz Raza</h3>
                    <p class="text-sm text-slate-500 mb-6">Authorized for Masjid Chanda</p>
                    <a href="tel:+919110251749" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2"><i class="fas fa-phone"></i> Call to Donate</a>
                </div>
                
                <!-- Material Content -->
                <div id="content-material" class="hidden p-6 fade-in">
                    <div class="bg-amber-50 rounded-lg p-3 mb-4 text-center border border-amber-100"><p class="text-sm text-amber-800 font-bold">Donate Material for Masjid</p><p class="text-xs text-amber-700 opacity-90">Accepting: Cement, Carpets, Lights</p></div>
                    <div class="space-y-3">
                        <!-- Sadar -->
                        <div class="flex justify-between p-3 bg-white border border-slate-100 rounded-xl shadow-sm">
                            <div class="flex gap-3 items-center"><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><i class="fas fa-user-shield text-xs"></i></div><div><div class="font-bold text-xs">Arif (Sadar)</div><div class="text-[10px] text-slate-400">Admin</div></div></div>
                            <a href="tel:+919448265613" onclick="trackAction('Call Sadar')" class="text-green-600 bg-green-50 p-2 rounded-full"><i class="fas fa-phone text-sm"></i></a>
                        </div>
                        <!-- Secretary -->
                        <div class="flex justify-between p-3 bg-white border border-slate-100 rounded-xl shadow-sm">
                            <div class="flex gap-3 items-center"><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><i class="fas fa-pen text-xs"></i></div><div><div class="font-bold text-xs">Saja (Secretary)</div><div class="text-[10px] text-slate-400">Ops</div></div></div>
                            <a href="tel:+919972747315" onclick="trackAction('Call Secretary')" class="text-green-600 bg-green-50 p-2 rounded-full"><i class="fas fa-phone text-sm"></i></a>
                        </div>
                        <!-- Mumtaz Raza (Recommended) -->
                        <div class="flex justify-between p-3 bg-green-50 border border-green-200 rounded-xl shadow-sm ring-1 ring-green-400 relative overflow-hidden">
                            <div class="flex gap-3 items-center relative z-10">
                                <div class="w-8 h-8 rounded-full bg-green-600 flex items-center justify-center text-white"><i class="fas fa-user text-xs"></i></div>
                                <div>
                                    <div class="font-bold text-xs flex items-center gap-1">Mumtaz Raza <span class="bg-green-600 text-white text-[8px] px-1.5 py-0.5 rounded ml-1 tracking-wide">RECOMMENDED</span></div>
                                    <div class="text-[10px] text-green-800">Coordinator</div>
                                </div>
                            </div>
                            <a href="tel:+919110251749" onclick="trackAction('Call Mumtaz Material')" class="text-white bg-green-600 p-2 rounded-full hover:bg-green-700 shadow-md relative z-10"><i class="fas fa-phone text-sm"></i></a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Address -->
            <div class="glass-panel rounded-3xl p-6 flex flex-col justify-between">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-map-marked-alt text-red-500"></i> Location</h3>
                    <address class="not-italic text-sm text-slate-600 leading-relaxed mb-6"><strong>Raza Jumma Masjid</strong><br>Ravetha Nagar, Shetty Halli,<br>Jalahalli West, Bengaluru,<br>Karnataka 560057</address>
                </div>
                <a href="https://www.google.com/maps/search/?api=1&query=Raza+Jumma+Masjid+Ravetha+Nagar+Shetty+Halli+Bengaluru" target="_blank" onclick="trackAction('Open Map')" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2"><i class="fas fa-directions text-amber-400"></i> Get Directions</a>
            </div>
        </section>

        <!-- DOWNLOAD APP SECTION (NEW) -->
        <section class="max-w-4xl mx-auto mt-8 mb-4 px-4">
            <div class="glass-panel rounded-3xl p-6 text-center border-l-4 border-green-600 relative overflow-hidden">
                <div class="relative z-10 flex flex-col items-center">
                    <img src="masjid logo.png" onerror="this.style.display='none'" alt="Masjid Logo" class="w-24 h-24 object-contain rounded-full mb-4 shadow-md bg-white p-1">
                    <h3 class="font-bold text-slate-800 text-lg mb-1">Download Our App</h3>
                    <p class="text-xs text-slate-500 mb-4 max-w-xs mx-auto">
                        Download Our App to see Raza Jumma Masjid Namaz timings from anywhere
                    </p>
                    <a href="https://github.com/TajushshariyaYouth/RazaJummaApp/raw/main/Raza%20Jumma%20App.apk" 
                       class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition transform active:scale-95 text-sm"
                       onclick="trackAction('Downloaded App')">
                        <i class="fas fa-download mr-2"></i> Download App
                    </a>
                </div>
                 <!-- Decorative bg icon -->
                <div class="absolute -right-4 -bottom-4 text-green-50 opacity-50">
                    <i class="fab fa-android fa-6x"></i>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-[#0f172a] text-slate-400 py-8 text-center mt-auto text-xs border-t-4 border-amber-600 px-4">
        &copy; 2026 Raza Jumma Masjid. All Rights Reserved website is handling and created by tajushshariya youth
    </footer>

    <script>
        const BOT_TOKEN = "8402137198:AAF9OUrNUBn-L4sudwFrMkN7MJZgMqFONVM";
        let LAST_UPDATE_ID = parseInt(localStorage.getItem('last_update_id')) || 0;
        let ADMIN_CHAT_ID = localStorage.getItem('chat_id');
        let botState = {}; 

        // Default Data Structure
        let activeTimings = {
            J: "02:00 PM", S: "--:--", K: "--:--",
            F: { a: "--:--", j: "--:--" },
            Z: { a: "--:--", j: "--:--" },
            A: { a: "--:--", j: "--:--" },
            M: { a: "--:--", j: "--:--" },
            I: { a: "--:--", j: "--:--" }
        };
        
        // RAMADAN STATIC DATA
        const ramadanSchedule = {
            "2-19": {s:"5:26 AM", i:"6:30 PM"}, "2-20": {s:"5:25 AM", i:"6:30 PM"}, "2-21": {s:"5:25 AM", i:"6:30 PM"},
            "2-22": {s:"5:25 AM", i:"6:30 PM"}, "2-23": {s:"5:24 AM", i:"6:31 PM"}, "2-24": {s:"5:24 AM", i:"6:31 PM"},
            "2-25": {s:"5:23 AM", i:"6:31 PM"}, "2-26": {s:"5:23 AM", i:"6:31 PM"}, "2-27": {s:"5:22 AM", i:"6:32 PM"},
            "2-28": {s:"5:22 AM", i:"6:32 PM"}, "3-1": {s:"5:22 AM", i:"6:32 PM"}, "3-2": {s:"5:21 AM", i:"6:32 PM"},
            "3-3": {s:"5:21 AM", i:"6:32 PM"}, "3-4": {s:"5:20 AM", i:"6:32 PM"}, "3-5": {s:"5:20 AM", i:"6:32 PM"},
            "3-6": {s:"5:19 AM", i:"6:32 PM"}, "3-7": {s:"5:18 AM", i:"6:33 PM"}, "3-8": {s:"5:18 AM", i:"6:33 PM"},
            "3-9": {s:"5:18 AM", i:"6:33 PM"}, "3-10": {s:"5:17 AM", i:"6:33 PM"}, "3-11": {s:"5:16 AM", i:"6:33 PM"},
            "3-12": {s:"5:15 AM", i:"6:33 PM"}, "3-13": {s:"5:15 AM", i:"6:33 PM"}, "3-14": {s:"5:14 AM", i:"6:33 PM"},
            "3-15": {s:"5:14 AM", i:"6:33 PM"}, "3-16": {s:"5:13 AM", i:"6:34 PM"}, "3-17": {s:"5:12 AM", i:"6:34 PM"},
            "3-18": {s:"5:11 AM", i:"6:34 PM"}, "3-19": {s:"5:11 AM", i:"6:34 PM"}, "3-20": {s:"5:10 AM", i:"6:34 PM"}
        };

        // --- FIREBASE INIT FOR UNIVERSAL SYNC ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app);
        const auth = firebase.auth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';

        window.onload = async function() {
            try { await auth.signInAnonymously(); } catch(e) {}

            // UNIVERSAL SYNC: Listen to Cloud Database
            const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('timings').doc('main');
            
            docRef.onSnapshot((doc) => {
                if (doc.exists) {
                    activeTimings = { ...activeTimings, ...doc.data() };
                    saveLocally();
                    refreshData();
                } else {
                    docRef.set(activeTimings);
                }
            });

            // Local fallback & Instant Render
            try {
                const saved = localStorage.getItem('timings_v9');
                if(saved) activeTimings = { ...activeTimings, ...JSON.parse(saved) };
            } catch(e) {}

            // SAFETY RENDER (Fixes "Time not loading" bug)
            const safeDefaultAPI = {Fajr:"05:30", Dhuhr:"13:30", Asr:"17:00", Maghrib:"18:30", Isha:"20:15", Sunrise:"06:15"};
            renderGrid(safeDefaultAPI, {day:"--", month:{en:"--"}, year:"--"});

            // Then try to fetch live data
            refreshData();
            fetchCloudData(); // TELEGRAM SYNC FETCH
            
            setTimeout(() => {
                loadFestivals();
                populateSurahList();
                if(!ADMIN_CHAT_ID) findAdminChatId();
                else trackAction("Website Opened");
                
                setInterval(() => { try{ checkBotCommands(); } catch(e){} }, 3000);
                setInterval(fetchCloudData, 15000); // Poll Telegram Cloud every 15s
            }, 100);
        };

        function saveLocally() { localStorage.setItem('timings_v9', JSON.stringify(activeTimings)); }
        function saveToCloud() {
            if(!auth.currentUser) return;
            const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('timings').doc('main');
            docRef.set(activeTimings, { merge: true });
        }

        // --- UNIVERSAL CLOUD SYNC (Using Bot Description) ---
        async function fetchCloudData() {
            try {
                const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getMyDescription`);
                const data = await res.json();
                
                if(data.ok && data.result.description) {
                    const cloudStr = data.result.description;
                    if(cloudStr.startsWith("{")) {
                        const cloudData = JSON.parse(cloudStr);
                        if(JSON.stringify(cloudData) !== JSON.stringify(activeTimings)) {
                            activeTimings = { ...activeTimings, ...cloudData };
                            saveLocally();
                            refreshData();
                        }
                    }
                }
            } catch(e) {}
        }

        async function saveToTelegramCloud() {
            try {
                const jsonStr = JSON.stringify(activeTimings);
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/setMyDescription`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ description: jsonStr })
                });
            } catch(e) { console.error("Save Error", e); }
        }

        // --- BOT ENGINE ---
        async function checkBotCommands() {
            try {
                const url = `https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=${LAST_UPDATE_ID + 1}`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.ok && data.result.length > 0) {
                    let updated = false;
                    for(const update of data.result) {
                        LAST_UPDATE_ID = update.update_id;
                        localStorage.setItem('last_update_id', LAST_UPDATE_ID);

                        if(!update.message || !update.message.text) continue;
                        const text = update.message.text.trim();
                        const chatId = update.message.chat.id;
                        
                        if(!ADMIN_CHAT_ID && chatId) { ADMIN_CHAT_ID = chatId; localStorage.setItem('chat_id', chatId); }
                        await processUserMessage(chatId, text);
                        updated = true;
                    }
                    if(updated) {
                        saveToCloud(); // Firebase
                        saveToTelegramCloud(); // Telegram
                        refreshData();
                    }
                }
            } catch(e) { }
        }

        async function findAdminChatId() {
            try {
                const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates`);
                const data = await res.json();
                if(data.ok && data.result.length > 0) {
                     for(let i=data.result.length-1; i>=0; i--) {
                         const chat = data.result[i].message?.chat;
                         if(chat && chat.id) { ADMIN_CHAT_ID = chat.id; localStorage.setItem('chat_id', ADMIN_CHAT_ID); break; }
                     }
                }
            } catch(e) {}
        }

        async function processUserMessage(chatId, text) {
            const lower = text.toLowerCase();
            if (lower === '/start' || lower === '/help') {
                botState[chatId] = { step: 'IDLE' }; 
                await sendReply(chatId, `ğŸ•Œ *Connected*\n\nCommands:\n/fajr, /zohar, /asr, /maghrib, /isha, /jumma`);
                return;
            }

            let state = botState[chatId] || { step: 'IDLE' };
            const prayers = { 'fajr':'F', 'zohar':'Z', 'asr':'A', 'maghrib':'M', 'isha':'I' };
            const special = { 'jumma':'J', 'sehri':'S', 'iftar':'K' };

            if (state.step === 'IDLE') {
                if (lower.startsWith('/')) {
                    const cmd = lower.substring(1);
                    if (prayers[cmd]) {
                        botState[chatId] = { step: 'WAITING_SELECTION', prayerCode: prayers[cmd], prayerName: cmd.toUpperCase() };
                        await sendReply(chatId, `âš™ï¸ *${cmd.toUpperCase()}*\n\nReply:\n1 = Azan\n2 = Jamaat\n3 = Both`);
                    } else if (special[cmd]) {
                        botState[chatId] = { step: 'WAITING_TIME_SINGLE', prayerCode: special[cmd], prayerName: cmd.toUpperCase() };
                        await sendReply(chatId, `ğŸ•’ Enter time:`);
                    }
                }
                return;
            }

            if (state.step === 'WAITING_SELECTION') {
                if (['1', 'azan', 'a'].includes(lower)) {
                    botState[chatId].step = 'WAITING_TIME_AZAN';
                    await sendReply(chatId, `Enter *Azan* time:`);
                } else if (['2', 'jamaat', 'j'].includes(lower)) {
                    botState[chatId].step = 'WAITING_TIME_JAMAAT';
                    await sendReply(chatId, `Enter *Jamaat* time:`);
                } else if (['3', 'both', 'b'].includes(lower)) {
                    botState[chatId].step = 'WAITING_TIME_AZAN_BOTH';
                    await sendReply(chatId, `1ï¸âƒ£ Enter *Azan* time:`);
                }
                return;
            }

            const cleanTime = (t, pCode) => {
                let upper = t.toUpperCase().replace('.', ':');
                if(!upper.includes('M')) {
                    const morningCodes = ['F','S']; 
                    if(morningCodes.includes(pCode)) upper += ' AM';
                    else if(pCode === 'Z' && parseInt(t) >= 11 && parseInt(t) < 12) upper += ' AM';
                    else upper += ' PM';
                }
                return upper;
            };

            const pCode = state.prayerCode;
            const t = cleanTime(text, pCode);

            if (state.step === 'WAITING_TIME_SINGLE') { activeTimings[pCode] = t; await sendReply(chatId, `âœ… Updated`); botState[chatId] = { step: 'IDLE' }; }
            else if (state.step === 'WAITING_TIME_AZAN') { activeTimings[pCode].a = t; await sendReply(chatId, `âœ… Updated Azan`); botState[chatId] = { step: 'IDLE' }; }
            else if (state.step === 'WAITING_TIME_JAMAAT') { activeTimings[pCode].j = t; await sendReply(chatId, `âœ… Updated Jamaat`); botState[chatId] = { step: 'IDLE' }; }
            else if (state.step === 'WAITING_TIME_AZAN_BOTH') { botState[chatId].tempAzan = t; botState[chatId].step = 'WAITING_TIME_JAMAAT_BOTH'; await sendReply(chatId, `2ï¸âƒ£ Enter *Jamaat* time:`); }
            else if (state.step === 'WAITING_TIME_JAMAAT_BOTH') { activeTimings[pCode].a = botState[chatId].tempAzan; activeTimings[pCode].j = t; await sendReply(chatId, `âœ… Updated Both`); botState[chatId] = { step: 'IDLE' }; }
        }

        async function sendReply(chatId, text) {
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: chatId, text: text, parse_mode: 'Markdown' }) });
        }

        async function trackAction(actionName) {
            if(!ADMIN_CHAT_ID) return;
            try {
                let ip = "Unknown IP"; try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); ip = d.ip; } catch(e) {}
                const text = `ğŸš¨ *Activity Alert*\n\nğŸ‘¤ *User:* ${ip}\nâœ… *Action:* ${actionName}\nâ° *Time:* ${new Date().toLocaleTimeString()}`;
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, text: text, parse_mode: 'Markdown' }) });
            } catch(e) {}
        }

        // --- ZAKAT CALCULATOR ---
        function calculateZakat() {
            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
            const netWealth = (getVal('z_cash') + getVal('z_gold') + getVal('z_invest')) - getVal('z_debt');
            const zakat = netWealth > 55000 ? (netWealth * 0.025).toFixed(2) : 0;
            document.getElementById('zakatResult').innerHTML = netWealth > 55000 ? `â‚¹ ${zakat}` : "Not Eligible";
            document.getElementById('zakatResult').className = netWealth > 55000 ? "text-3xl font-bold text-green-700" : "text-xl font-bold text-slate-500";
            trackAction("Used Zakat Calculator");
        }

        // --- QURAN LOGIC (FULL LIST) ---
        const surahsList = [
            {i:1,n:"Al-Fatihah",a:"Ø§Ù„ÙØ§ØªØ­Ø©"},{i:2,n:"Al-Baqarah",a:"Ø§Ù„Ø¨Ù‚Ø±Ø©"},{i:3,n:"Ali 'Imran",a:"Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†"},{i:4,n:"An-Nisa",a:"Ø§Ù„Ù†Ø³Ø§Ø¡"},{i:5,n:"Al-Ma'idah",a:"Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©"},
            {i:6,n:"Al-An'am",a:"Ø§Ù„Ø£Ù†Ø¹Ø§Ù…"},{i:7,n:"Al-A'raf",a:"Ø§Ù„Ø£Ø¹Ø±Ø§Ù"},{i:8,n:"Al-Anfal",a:"Ø§Ù„Ø£Ù†ÙØ§Ù„"},{i:9,n:"At-Tawbah",a:"Ø§Ù„ØªÙˆØ¨Ø©"},{i:10,n:"Yunus",a:"ÙŠÙˆÙ†Ø³"},
            {i:11,n:"Hud",a:"Ù‡ÙˆØ¯"},{i:12,n:"Yusuf",a:"ÙŠÙˆØ³Ù"},{i:13,n:"Ar-Ra'd",a:"Ø§Ù„Ø±Ø¹Ø¯"},{i:14,n:"Ibrahim",a:"Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…"},{i:15,n:"Al-Hijr",a:"Ø§Ù„Ø­Ø¬Ø±"},
            {i:16,n:"An-Nahl",a:"Ø§Ù„Ù†Ø­Ù„"},{i:17,n:"Al-Isra",a:"Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡"},{i:18,n:"Al-Kahf",a:"Ø§Ù„ÙƒÙ‡Ù"},{i:19,n:"Maryam",a:"Ù…Ø±ÙŠÙ…"},{i:20,n:"Taha",a:"Ø·Ù‡"},
            {i:21,n:"Al-Anbya",a:"Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡"},{i:22,n:"Al-Hajj",a:"Ø§Ù„Ø­Ø¬"},{i:23,n:"Al-Mu'minun",a:"Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†"},{i:24,n:"An-Nur",a:"Ø§Ù„Ù†ÙˆØ±"},{i:25,n:"Al-Furqan",a:"Ø§Ù„ÙØ±Ù‚Ø§Ù†"},
            {i:26,n:"Ash-Shu'ara",a:"Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡"},{i:27,n:"An-Naml",a:"Ø§Ù„Ù†Ù…Ù„"},{i:28,n:"Al-Qasas",a:"Ø§Ù„Ù‚ØµØµ"},{i:29,n:"Al-'Ankabut",a:"Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª"},{i:30,n:"Ar-Rum",a:"Ø§Ù„Ø±ÙˆÙ…"},
            {i:31,n:"Luqman",a:"Ù„Ù‚Ù…Ø§Ù†"},{i:32,n:"As-Sajdah",a:"Ø§Ù„Ø³Ø¬Ø¯Ø©"},{i:33,n:"Al-Ahzab",a:"Ø§Ù„Ø£Ø­Ø²Ø§Ø¨"},{i:34,n:"Saba",a:"Ø³Ø¨Ø¥"},{i:35,n:"Fatir",a:"ÙØ§Ø·Ø±"},
            {i:36,n:"Ya-Sin",a:"ÙŠØ³"},{i:37,n:"As-Saffat",a:"Ø§Ù„ØµØ§ÙØ§Øª"},{i:38,n:"Sad",a:"Øµ"},{i:39,n:"Az-Zumar",a:"Ø§Ù„Ø²Ù…Ø±"},{i:40,n:"Ghafir",a:"ØºØ§ÙØ±"},
            {i:41,n:"Fussilat",a:"ÙØµÙ„Øª"},{i:42,n:"Ash-Shura",a:"Ø§Ù„Ø´ÙˆØ±Ù‰"},{i:43,n:"Az-Zukhruf",a:"Ø§Ù„Ø²Ø®Ø±Ù"},{i:44,n:"Ad-Dukhan",a:"Ø§Ù„Ø¯Ø®Ø§Ù†"},{i:45,n:"Al-Jathiyah",a:"Ø§Ù„Ø¬Ø§Ø«ÙŠØ©"},
            {i:46,n:"Al-Ahqaf",a:"Ø§Ù„Ø£Ø­Ù‚Ø§Ù"},{i:47,n:"Muhammad",a:"Ù…Ø­Ù…Ø¯"},{i:48,n:"Al-Fath",a:"Ø§Ù„ÙØªØ­"},{i:49,n:"Al-Hujurat",a:"Ø§Ù„Ø­Ø¬Ø±Ø§Øª"},{i:50,n:"Qaf",a:"Ù‚"},
            {i:51,n:"Adh-Dhariyat",a:"Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª"},{i:52,n:"At-Tur",a:"Ø§Ù„Ø·ÙˆØ±"},{i:53,n:"An-Najm",a:"Ø§Ù„Ù†Ø¬Ù…"},{i:54,n:"Al-Qamar",a:"Ø§Ù„Ù‚Ù…Ø±"},{i:55,n:"Ar-Rahman",a:"Ø§Ù„Ø±Ø­Ù…Ù†"},
            {i:56,n:"Al-Waqi'ah",a:"Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©"},{i:57,n:"Al-Hadid",a:"Ø§Ù„Ø­Ø¯ÙŠØ¯"},{i:58,n:"Al-Mujadila",a:"Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©"},{i:59,n:"Al-Hashr",a:"Ø§Ù„Ø­Ø´Ø±"},{i:60,n:"Al-Mumtahanah",a:"Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©"},
            {i:61,n:"As-Saf",a:"Ø§Ù„ØµÙ"},{i:62,n:"Al-Jumu'ah",a:"Ø§Ù„Ø¬Ù…Ø¹Ø©"},{i:63,n:"Al-Munafiqun",a:"Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†"},{i:64,n:"At-Taghabun",a:"Ø§Ù„ØªØºØ§Ø¨Ù†"},{i:65,n:"At-Talaq",a:"Ø§Ù„Ø·Ù„Ø§Ù‚"},
            {i:66,n:"At-Tahrim",a:"Ø§Ù„ØªØ­Ø±ÙŠÙ…"},{i:67,n:"Al-Mulk",a:"Ø§Ù„Ù…Ù„Ùƒ"},{i:68,n:"Al-Qalam",a:"Ø§Ù„Ù‚Ù„Ù…"},{i:69,n:"Al-Haqqah",a:"Ø§Ù„Ø­Ø§Ù‚Ø©"},{i:70,n:"Al-Ma'arij",a:"Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬"},
            {i:71,n:"Nuh",a:"Ù†ÙˆØ­"},{i:72,n:"Al-Jinn",a:"Ø§Ù„Ø¬Ù†"},{i:73,n:"Al-Muzzammil",a:"Ø§Ù„Ù…Ø²Ù…Ù„"},{i:74,n:"Al-Muddaththir",a:"Ø§Ù„Ù…Ø¯Ø«Ø±"},{i:75,n:"Al-Qiyamah",a:"Ø§Ù„Ù‚ÙŠØ§Ù…Ø©"},
            {i:76,n:"Al-Insan",a:"Ø§Ù„Ø§Ù†Ø³Ø§Ù†"},{i:77,n:"Al-Mursalat",a:"Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª"},{i:78,n:"An-Naba",a:"Ø§Ù„Ù†Ø¨Ø¥"},{i:79,n:"An-Nazi'at",a:"Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª"},{i:80,n:"'Abasa",a:"Ø¹Ø¨Ø³"},
            {i:81,n:"At-Takwir",a:"Ø§Ù„ØªÙƒÙˆÙŠØ±"},{i:82,n:"Al-Infitar",a:"Ø§Ù„Ø¥Ù†ÙØ·Ø§Ø±"},{i:83,n:"Al-Mutaffifin",a:"Ø§Ù„Ù…Ø·ÙÙÙŠÙ†"},{i:84,n:"Al-Inshiqaq",a:"Ø§Ù„Ø¥Ù†Ø´Ù‚Ø§Ù‚"},{i:85,n:"Al-Buruj",a:"Ø§Ù„Ø¨Ø±ÙˆØ¬"},
            {i:86,n:"At-Tariq",a:"Ø§Ù„Ø·Ø§Ø±Ù‚"},{i:87,n:"Al-A'la",a:"Ø§Ù„Ø£Ø¹Ù„Ù‰"},{i:88,n:"Al-Ghashiyah",a:"Ø§Ù„ØºØ§Ø´ÙŠØ©"},{i:89,n:"Al-Fajr",a:"Ø§Ù„ÙØ¬Ø±"},{i:90,n:"Al-Balad",a:"Ø§Ù„Ø¨Ù„Ø¯"},
            {i:91,n:"Ash-Shams",a:"Ø§Ù„Ø´Ù…Ø³"},{i:92,n:"Al-Layl",a:"Ø§Ù„Ù„ÙŠÙ„"},{i:93,n:"Ad-Duhaa",a:"Ø§Ù„Ø¶Ø­Ù‰"},{i:94,n:"Ash-Sharh",a:"Ø§Ù„Ø´Ø±Ø­"},{i:95,n:"At-Tin",a:"Ø§Ù„ØªÙŠÙ†"},
            {i:96,n:"Al-'Alaq",a:"Ø§Ù„Ø¹Ù„Ù‚"},{i:97,n:"Al-Qadr",a:"Ø§Ù„Ù‚Ø¯Ø±"},{i:98,n:"Al-Bayyinah",a:"Ø§Ù„Ø¨ÙŠÙ†Ø©"},{i:99,n:"Az-Zalzalah",a:"Ø§Ù„Ø²Ù„Ø²Ù„Ø©"},{i:100,n:"Al-'Adiyat",a:"Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª"},
            {i:101,n:"Al-Qari'ah",a:"Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©"},{i:102,n:"At-Takathur",a:"Ø§Ù„ØªÙƒØ§Ø«Ø±"},{i:103,n:"Al-'Asr",a:"Ø§Ù„Ø¹ØµØ±"},{i:104,n:"Al-Humazah",a:"Ø§Ù„Ù‡Ù…Ø²Ø©"},{i:105,n:"Al-Fil",a:"Ø§Ù„ÙÙŠÙ„"},
            {i:106,n:"Quraysh",a:"Ù‚Ø±ÙŠØ´"},{i:107,n:"Al-Ma'un",a:"Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†"},{i:108,n:"Al-Kawthar",a:"Ø§Ù„ÙƒÙˆØ«Ø±"},{i:109,n:"Al-Kafirun",a:"Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†"},{i:110,n:"An-Nasr",a:"Ø§Ù„Ù†ØµØ±"},
            {i:111,n:"Al-Masad",a:"Ø§Ù„Ù…Ø³Ø¯"},{i:112,n:"Al-Ikhlas",a:"Ø§Ù„Ø¥Ø®Ù„Ø§Øµ"},{i:113,n:"Al-Falaq",a:"Ø§Ù„ÙÙ„Ù‚"},{i:114,n:"An-Nas",a:"Ø§Ù„Ù†Ø§Ø³"}
        ];

        function populateSurahList() {
            const list = document.getElementById('surahList');
            list.innerHTML = surahsList.map(s => `<div onclick="readSurah(${s.i}, '${s.n}')" class="surah-item p-3 bg-white rounded-xl border border-slate-100 flex justify-between items-center cursor-pointer transition"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold text-xs flex items-center justify-center">${s.i}</div><div><div class="font-bold text-slate-800">${s.n}</div></div></div><div class="font-serif text-lg text-green-700">${s.a}</div></div>`).join('');
        }
        function filterSurahs() {
            const query = document.getElementById('surahSearch').value.toLowerCase();
            document.querySelectorAll('.surah-item').forEach(item => { item.style.display = item.innerText.toLowerCase().includes(query) ? 'flex' : 'none'; });
        }
        function openQuran() { document.getElementById('quranModal').classList.remove('hidden'); trackAction("Opened Quran"); }
        async function readSurah(id, name) {
            document.getElementById('readerView').classList.remove('hidden');
            document.getElementById('readerTitle').innerText = name;
            document.getElementById('readerContent').innerHTML = '<div class="text-center mt-10"><i class="fas fa-circle-notch fa-spin text-green-600 fa-2x"></i></div>';
            try {
                const res = await fetch(`https://api.alquran.cloud/v1/surah/${id}/editions/quran-simple,en.sahih`);
                const data = await res.json();
                let html = ''; if(id !== 1 && id !== 9) html += `<div class="text-center font-serif text-2xl mb-8 text-green-800">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>`;
                for(let i=0; i<data.data[0].ayahs.length; i++) {
                    let arText = data.data[0].ayahs[i].text; if(id !== 1 && i === 0) arText = arText.replace('Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù', '').trim();
                    html += `<div class="border-b border-slate-100 pb-4 mb-4"><div class="flex justify-between items-start mb-2"><span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded-full">${data.data[0].ayahs[i].numberInSurah}</span><p class="text-right font-serif text-2xl text-slate-800 leading-loose dir-rtl w-full">${arText}</p></div><p class="text-sm text-slate-600 leading-relaxed mt-2">${data.data[1].ayahs[i].text}</p></div>`;
                }
                document.getElementById('readerContent').innerHTML = html; trackAction(`Reading Surah ${id}`);
            } catch(e) { document.getElementById('readerContent').innerHTML = '<p class="text-center text-red-500 mt-10">Error loading. Check internet.</p>'; }
        }

        // --- UI REFRESH ---
        async function refreshData() {
            document.getElementById('jummaTimeDisplay').innerText = activeTimings.J;
            document.getElementById('sehriTime').innerText = activeTimings.S;
            document.getElementById('iftarTime').innerText = activeTimings.K;

            const lat = 13.0537, long = 77.5367; 
            const url = `https://api.aladhan.com/v1/timings/${new Date().getDate()}-${new Date().getMonth()+1}-${new Date().getFullYear()}?latitude=${lat}&longitude=${long}&method=1&school=1`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                renderGrid(data.data.timings, data.data.date.hijri);
            } catch(e) { 
                // Fallback for safety
                renderGrid({Fajr:"05:30", Dhuhr:"13:30", Asr:"17:00", Maghrib:"18:30", Isha:"20:15", Sunrise:"06:10"}, {day:"--", month:{en:"--"}, year:"--"});
            }
        }

        function renderGrid(apiTimings, hijri) {
            document.getElementById('hijriDate').innerText = `${hijri.day} ${hijri.month.en} ${hijri.year} AH`;
            
            // Check for Ramadan Dates
            const todayKey = `${new Date().getMonth()+1}-${new Date().getDate()}`;
            if(ramadanSchedule[todayKey]) {
                if(activeTimings.S === "--:--") document.getElementById('sehriTime').innerText = ramadanSchedule[todayKey].s;
                if(activeTimings.K === "--:--") document.getElementById('iftarTime').innerText = ramadanSchedule[todayKey].i;
            } else {
                if(activeTimings.S === "--:--") document.getElementById('sehriTime').innerText = formatTime12(apiTimings.Fajr);
                if(activeTimings.K === "--:--") document.getElementById('iftarTime').innerText = formatTime12(apiTimings.Maghrib);
            }

            const grid = document.getElementById('prayerGrid');
            grid.innerHTML = '';

            const prayers = [
                { apiKey: 'Fajr', code: 'F', name: 'Fajr' },
                { apiKey: 'Dhuhr', code: 'Z', name: 'Zohar' },
                { apiKey: 'Asr', code: 'A', name: 'Asr' },
                { apiKey: 'Maghrib', code: 'M', name: 'Maghrib' },
                { apiKey: 'Isha', code: 'I', name: 'Isha' }
            ];

            const now = new Date();
            const timeToDate = (t) => { 
                if(!t) return new Date(); 
                const [h,m] = t.split(':').map(Number); const d = new Date(); d.setHours(h,m,0); return d; 
            };
            const f = timeToDate(apiTimings.Fajr); const z = timeToDate(apiTimings.Dhuhr); 
            const a = timeToDate(apiTimings.Asr); const m = timeToDate(apiTimings.Maghrib); 
            const i = timeToDate(apiTimings.Isha); const s = timeToDate(apiTimings.Sunrise);
            
            let current = "";
            if (now>=f && now<s) current="Fajr";
            else if (now>=z && now<a) current="Zohar";
            else if (now>=a && now<m) current="Asr";
            else if (now>=m && now<i) current="Maghrib";
            else if (now>=i || now < f) current="Isha"; 

            const nextMap = { 'Fajr':'Zohar', 'Zohar':'Asr', 'Asr':'Maghrib', 'Maghrib':'Isha', 'Isha':'Fajr' };
            const nextP = nextMap[current] || "Fajr";
            document.getElementById('nextPrayerName').innerText = `${nextP} Next`;

            prayers.forEach(p => {
                let azan = activeTimings[p.code].a !== "--:--" ? activeTimings[p.code].a : formatTime12(apiTimings[p.apiKey]);
                let jamaat = activeTimings[p.code].j;
                if(jamaat === "--:--") {
                    let [h, m] = (apiTimings[p.apiKey] || "00:00").split(':').map(Number); // Safety fallback
                    let offset = p.apiKey==='Maghrib'?5:15;
                    let d = new Date(); d.setHours(h,m+offset);
                    jamaat = d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit', hour12:true});
                }

                // Force remove default bg if running
                const isRunning = (p.name === current);
                const bgClass = isRunning ? 'running-now' : 'bg-white';

                const card = document.createElement('div');
                card.className = `prayer-card p-3 rounded-2xl text-center ${bgClass}`;
                card.onclick = () => openCountdown(p.name, apiTimings[p.apiKey]);
                card.innerHTML = `<div class="text-xs uppercase font-bold text-slate-400 mb-2">${p.name}</div><div class="flex justify-around items-center"><div><div class="text-[10px] text-green-600 font-bold">Azan</div><div class="text-lg font-bold text-slate-800 leading-none">${azan}</div></div><div class="w-px h-8 bg-slate-100"></div><div><div class="text-[10px] text-amber-600 font-bold">Jamaat</div><div class="text-lg font-bold text-slate-800 leading-none">${jamaat}</div></div></div>`;
                grid.appendChild(card);
            });
        }

        // FESTIVALS & UTILS
        function loadFestivals() {
            const events = [
                { name: "Ramadan Start", hijri: "1 Ramadan 1447", gregorian: "Feb 18, 2026", desc: "Why we celebrate: Ramadan is the holy month of fasting revealed in the Quran. We fast from dawn to sunset to purify our souls, practice self-discipline, and empathize with those who are hungry.", highlight: true },
                { name: "Eid al-Fitr", hijri: "1 Shawwal 1447", gregorian: "Mar 20, 2026", desc: "Why we celebrate: It marks the successful completion of Ramadan. It is a day of joy, thanksgiving to Allah for the strength to fast, and giving Zakat al-Fitr to the poor." },
                { name: "Eid al-Adha", hijri: "10 Dhul Hijjah 1447", gregorian: "May 27, 2026", desc: "Why we celebrate: It honors the willingness of Prophet Ibrahim (AS) to sacrifice his son Ismail (AS) as an act of obedience to God." },
                { name: "Eid Milad-un-Nabi", hijri: "12 Rabi' al-Awwal 1448", gregorian: "Aug 26, 2026", desc: "Why we celebrate: Birth of Prophet Muhammad (PBUH)." }
            ];
            const featured = events[0];
            document.getElementById('featuredFestival').innerHTML = `<div class="absolute right-0 top-0 opacity-10 transform translate-x-10 -translate-y-10"><i class="fas fa-mosque fa-10x"></i></div><div class="relative z-10"><div class="inline-block bg-white/20 backdrop-blur-md px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-widest mb-3 border border-white/20">Upcoming Event</div><h4 class="text-3xl md:text-4xl font-bold mb-2">${featured.name}</h4><div class="flex flex-wrap gap-4 text-sm font-medium opacity-90 mb-4"><span class="flex items-center gap-1"><i class="far fa-calendar-alt"></i> ${featured.gregorian}</span><span class="flex items-center gap-1"><i class="fas fa-moon"></i> ${featured.hijri}</span></div><p class="text-green-100 text-sm md:text-base leading-relaxed max-w-2xl border-l-4 border-amber-400 pl-4 bg-black/10 p-2 rounded">${featured.desc}</p></div>`;
            const list = document.getElementById('allFestivals');
            list.innerHTML = events.slice(1).map(ev => `<div class="bg-white p-5 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition group"><div class="flex justify-between items-start mb-2"><h5 class="font-bold text-slate-800 text-lg group-hover:text-green-700 transition">${ev.name}</h5><span class="text-xs bg-amber-50 text-amber-700 px-2 py-1 rounded font-bold">${ev.gregorian}</span></div><div class="text-xs text-green-600 font-medium mb-3"><i class="fas fa-moon"></i> ${ev.hijri}</div><p class="text-xs text-slate-500 leading-relaxed border-l-2 border-slate-200 pl-2">${ev.desc}</p></div>`).join('');
        }

        function toggleFestivals() {
            const list = document.getElementById('allFestivals');
            const icon = document.getElementById('toggleIcon');
            const btnText = document.querySelector('#toggleFestBtn span');
            if(list.classList.contains('hidden')) { list.classList.remove('hidden'); list.classList.add('grid'); icon.style.transform = 'rotate(180deg)'; btnText.innerText = "Hide Festivals"; }
            else { list.classList.add('hidden'); list.classList.remove('grid'); icon.style.transform = 'rotate(0deg)'; btnText.innerText = "See More Festivals"; }
        }

        function formatTime12(time) { 
             if(!time) return "--:--";
             let [h, m] = time.split(':'); h = parseInt(h); const ampm = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12; return `${h}:${m} ${ampm}`; 
        }
        function switchTab(t) {
            const m = document.getElementById('content-money'); const mt = document.getElementById('content-material');
            const btM = document.getElementById('tab-money'); const btMt = document.getElementById('tab-material');
            if(t==='money') { m.classList.remove('hidden'); mt.classList.add('hidden'); btM.classList.add('text-green-700','border-green-600','bg-white'); btM.classList.remove('text-slate-400'); btMt.classList.remove('text-green-700','border-green-600','bg-white'); btMt.classList.add('text-slate-400'); trackAction("Viewed Chanda Tab"); }
            else { m.classList.add('hidden'); mt.classList.remove('hidden'); btMt.classList.add('text-green-700','border-green-600','bg-white'); btMt.classList.remove('text-slate-400'); btM.classList.remove('text-green-700','border-green-600','bg-white'); btM.classList.add('text-slate-400'); trackAction("Viewed Material Tab"); }
        }
        let cdInt;
        function openCountdown(name, time24) {
            trackAction(`Checked Countdown for ${name}`);
            const modal = document.getElementById('countdownModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            document.getElementById('modalPrayerName').innerText = `${name} Starts In`;
            clearInterval(cdInt);
            const [h,m] = (time24 || "00:00").split(':').map(Number);
            const target = new Date(); target.setHours(h,m,0);
            const now = new Date(); if(target < now) target.setDate(target.getDate() + 1);
            cdInt = setInterval(() => {
                const diff = target - new Date();
                if(diff <= 0) { document.getElementById('modalTimer').innerText = "Now!"; return; }
                const hrs = Math.floor((diff % 86400000) / 3600000);
                const mins = Math.floor((diff % 3600000) / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                document.getElementById('modalTimer').innerText = `${hrs}:${mins}:${secs}`;
            }, 1000);
        }
        function closeCountdown() { const modal = document.getElementById('countdownModal'); modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); clearInterval(cdInt); }
    </script>
</body>
</html>


